package com.tpsup.fileCopy;

// C:/a/b/*/d should return
//    C:/a/b/c1/d
//    C:/a/b/c2/d
// C:/a/b/*/nosuchfile should return C:/a/b/*/nosuchfile
import java.io.File;
import java.io.IOException;
import java.nio.file.FileSystems;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.PathMatcher;
import java.nio.file.Paths;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class FileGlob {
    // this will be a static class: all methods are static
    public static Pattern HasGlobChar = Pattern.compile("[*?]");

    public static ArrayList<String> get(String pattern, HashMap<String, Object> opt) throws IOException {
        final ArrayList<String> results = new ArrayList<String>();
        // return the string if it is not pattern.
        {
            Matcher matcher = FileGlob.HasGlobChar.matcher(pattern);
            if (!matcher.find()) {
                results.add(pattern);
                return results;
            }
        }
        // convert \ to /. remove ending /
        pattern.replace("\\", "/").replace("/", "");
        // we need to start from the part without * or ?
        String[] parts = pattern.split("/");
        int full_length = parts.length;
        boolean[] is_glob = new boolean[full_length];
        PathMatcher[] compiled_patterns = new PathMatcher[full_length];
                
        for (int i=0; i<full_length; i++) {
            String part = parts[i];
            if (part.isEmpty()) {
                is_glob[i] = false;
                continue;
            }
            Matcher GlobMatcher = FileGlob.HasGlobChar.matcher(part);
            is_glob[i] = GlobMatcher.find();
            if (is_glob[i]) {
                compiled_patterns[i] = FileSystems.getDefault().getPathMatcher("glob:" + part);
            }
        }
        
        ArrayList<ArrayList<String>> todo = new ArrayList<ArrayList<String>>();
        ArrayList<String> seed = new ArrayList<String>();
        seed.add("/");
        todo.add(seed);
        while (true) {
            if (todo.isEmpty()) {
                break;
            }
            ArrayList<String> doing = todo.remove(todo.size() - 1);
            int i = doing.size();
            String next_part = parts[i];
            
            if (is_glob[i]) {
                // there is glob char in this pattern part
                String current_path = String.join("/", doing);
                File[] list = (new File(current_path)).listFiles();
                if (list != null) {
                    for (File f : list) {
                        // System.out.println(f.getPath()); // fullname
                        System.out.println(f.getName()); // shortname
                        String shortname = f.getName();
                        Path   shortPath = Paths.get(shortname);
                        //if (matcher.matches(f.toPath())) {
                        if (compiled_patterns[i].matches(shortPath)) {
                            ArrayList<String> new_item = (ArrayList<String>) doing.clone();
                            new_item.add(shortname);
                            if (doing.size() == full_length) {
                                results.add(String.join("/", new_item));
                            } else {
                                todo.add(new_item);
                            }
                        }
                    } 
                }
            } else {
                // no glob char in this pattern part
                doing.add(next_part);  
                String path = String.join("/", doing);
                if ((new File(path)).exists()) {                  
                    if (doing.size() == full_length) {                       
                        results.add(path);
                    } else {
                        todo.add(doing);
                    }
                } // else, this branch is discarded
            }
        }
        
        return null;
    }
//        String NonGlobPart = "";
//        int i = 0;

//        // trim the last /
//        NonGlobPart = NonGlobPart.substring(0, NonGlobPart.length() - 1);
//        // https://docs.oracle.com/javase/tutorial/essential/io/find.html
//        final PathMatcher matcher = FileSystems.getDefault().getPathMatcher("glob:" + pattern);
    public static void test() {
        File[] list = (new File("C:/users/william/github/tpsup/ps1")).listFiles();
        if (list != null) {
            for (File f : list) {
                System.out.println("fullname = " + f.getPath()); // fullname
                System.out.println("shortname = " + f.getName()); // shortname
                String shortname = f.getName();
                System.out.println("shortname to Path = " + Paths.get(shortname));
                System.out.println("file to Path = " + f.getPath());
            }
        }
    }

    static void usage() {
        System.err.println("java FileGlob \"<glob_pattern>\"");
        System.err.println("java FileGlob \"C:/users/william/git*/tpsup/*/*ps1\"");
        System.exit(-1);
    }

    public static void main(String[] args) throws IOException {
        if (args.length != 1)
            usage();
        String pattern = args[0];
        // System.out.println((new FileGlob()).get(pattern, null).toString());
        //test();
        System.out.println((new FileGlob()).get(pattern, null).toString());
    }
}
